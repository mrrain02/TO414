---
title: "Final Project: NBA Shot Analysis"
author: "R-Hinos"
date: "2023-12-05"
output: 
  html_document: 
    highlight: tango
    theme: united
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Dataset Information 

We chose the NBA Shooting Data from the 2022-2023 Season that gives information on all attempted shots from the season. The dataset has information regarding the game, the player that made the shot, who they were being guarded by, where they took the shot, how much time was left, and much more. The overall goal is to create an accurate model of whether a shot will be made depending on these factors. This can have significant implications, especially in the realm of sports betting, but also for the teams to better understand trends for their team and the opponents they are playing against. It can also have implications for player contract negotiations and creating a well balanced team of players. 

# Scraping Data 

We used the `nba_api` to gather the data from the 2022-2023 Season. Through this we were able to gather all shot information from the Regular Season, as well as personal information regarding each player to make our predictions more accurate. You can find the code used to scrape the information here [ADD LINK to GITHUB].


# Load Libraries
```{r}
library(caret)
library(neuralnet)
library(caret)
library(class)
library(kernlab)
library(C50)
library(tidyr)
library(dplyr)
library(janitor)
```


# Read Data
```{r}
nba <- read.csv("2022_shot_data.csv", stringsAsFactors = TRUE)
str(nba)
summary(nba)

# Randomize the rows so all player shots are not the same
set.seed(12345)
nba <- nba[sample(nrow(nba)),]

# 
set.seed(12345)
sample_size <- 0.1
nba <- nba[sample(1:nrow(nba), sample_size*nrow(nba)), ]

```

# Clean Data
```{r}
# Remove Unnecessary Columns 
nba$GRID_TYPE <- NULL
nba$GAME_ID <- NULL
nba$GAME_EVENT_ID <- NULL
nba$PLAYER_ID <- NULL
nba$PLAYER_NAME <- NULL
nba$TEAM_ID_x <- NULL
nba$EVENT_TYPE <- NULL
nba$SHOT_ATTEMPTED_FLAG <- NULL
nba$GAME_DATE <- NULL
nba$PLAYER_LAST_NAME <- NULL
nba$PLAYER_FIRST_NAME <- NULL
nba$PLAYER_SLUG <- NULL
nba$TEAM_ID_y <- NULL
nba$TEAM_SLUG <- NULL
nba$IS_DEFUNCT <- NULL
nba$TEAM_CITY <- NULL
nba$TEAM_NAME_x <- NULL
nba$TEAM_NAME_y <- NULL
nba$TEAM_ABBREVIATION <- NULL
nba$DRAFT_YEAR <- NULL
nba$DRAFT_NUMBER <- NULL
nba$STATS_TIMEFRAME <- NULL
nba$ROSTER_STATUS <- NULL


# Take Top 5 Colleges, Factorize Everything Else
nba$COLLEGE <- as.character(nba$COLLEGE)
nba$COLLEGE <- ifelse(!(nba$COLLEGE == "Kentucky" | nba$COLLEGE == "Duke" | nba$COLLEGE == "UCLA" |
nba$COLLEGE == "Arizona" | nba$COLLEGE == "Michigan"), "Other", nba$COLLEGE)
nba$COLLEGE <- as.factor(nba$COLLEGE)

# Take Top 3 Countries, Factorize Everything Else
nba$COUNTRY <- as.character(nba$COUNTRY)
nba$COUNTRY <- ifelse(!(nba$COUNTRY == "USA" | nba$COUNTRY == "Canada" | nba$COUNTRY == "Australia"), "Other", nba$COLLEGE)
nba$COUNTRY <- as.factor(nba$COUNTRY)

# Take Top 5 Heights, Factorize Everything Else 
nba$HEIGHT <- as.character(nba$HEIGHT)
nba$HEIGHT <- ifelse(!(nba$HEIGHT == "6-5" | nba$HEIGHT == "6-4" | nba$HEIGHT == "6-8" |
nba$HEIGHT == "6-6" | nba$HEIGHT == "6-7"), "Other", nba$HEIGHT)
nba$HEIGHT <- as.factor(nba$HEIGHT)

# Some Players are Undrafted, so Undraft Round and Number Will be Set to "0" to represent that (Make them factors as well)
nba$DRAFT_ROUND[is.na(nba$DRAFT_ROUND)] <- "un_draft"
nba$DRAFT_ROUND <- as.factor(nba$DRAFT_ROUND)

# PTS, REB, AST have some NA Values. We Replace NA values with the median in each column
nba$PTS[is.na(nba$PTS)] <- median(nba$PTS, na.rm = TRUE)
nba$REB[is.na(nba$REB)] <- median(nba$REB, na.rm = TRUE)
nba$AST[is.na(nba$AST)] <- median(nba$AST, na.rm = TRUE)


# Create New Column that Shows Total Number of Years in NBA
nba$YEARS_NBA <- (nba$TO_YEAR - nba$FROM_YEAR) + 1
nba$FROM_YEAR <- NULL
nba$TO_YEAR <- NULL

nba$SHOT_MADE_FLAG <- as.factor(nba$SHOT_MADE_FLAG)

# There are some NA's (less than 90). We are just going to remove these rows
nba <- na.omit(nba)

colSums(is.na(nba))

str(nba)
summary(nba)

```

# Pre Process Data
# Pre-Processing Data
```{r}
# Using model.matrix to convert all the factors to dummy variables
# We are converting all of the factors into dummy variables as the input into knn has to be numeric

nbamm <- as.data.frame(model.matrix(~.-1,nba))
nbamm <- clean_names(nbamm)
nbamm$action_type <- NULL
nbamm$height5_8 <- NULL
str(nbamm)


#Normalize the data
normalize <- function(x) {
  return ((x - min(x)) / (max(x) - min(x)))
}

# We are going to normalize everything for KNN and ANN
nba_norm <- as.data.frame(lapply(nbamm, normalize))
summary(nba_norm)
```


# Split Train and Test 
```{r}

set.seed(12345)
train_set <- sample(1:nrow(nba), 0.7*nrow(nba)) 

# Split for Logistical Regression 
nba_log_train <- nba[train_set, ]
nba_log_test <- nba[-train_set, ]

# Split for ANN
nba_ann_train <- nba_norm[train_set, ]
nba_ann_test <- nba_norm[-train_set, ]


# Split for SVM
nba_svm_train <- nbamm[train_set, ]
nba_svm_test <- nbamm[-train_set, ]

#Create a train set and test set with separate x and y cols
#First the predictors - all columns except the yyes column
nba_train <- nba_norm[train_set, -match("shot_made_flag1",names(nba_norm))]
nba_test <- nba_norm[-train_set, -match("shot_made_flag1",names(nba_norm))]

#Now the response (aka Labels) - only the yyes column
nba_train_labels <- nba_norm[train_set, "shot_made_flag1"]
nba_test_labels <- nba_norm[-train_set, "shot_made_flag1"]

```


# Logistical Regression 
```{r}

NbaModel=glm(SHOT_MADE_FLAG ~., data=nba_log_train,family="binomial")

# Use the logistic regression model 'NbaModel' to generate predictions on the test dataset

testpred1 <- predict(NbaModel, nba_log_test, type = "response")
# Convert the predicted probabilities into binary outcomes: 1 if probability >= 0.38, otherwise 0
binpred1 <- ifelse(testpred1 >=.5, 1, 0)
# Generate a confusion matrix to evaluate the performance of t-he predictions against the actual test labels

confusionMatrix(as.factor(binpred1), as.factor(nba_log_test$SHOT_MADE_FLAG), positive = "1")

```

# ANN Model
```{r}

ann_model <- neuralnet(shot_made_flag1 ~., data=nba_ann_train, hidden = 1)

# (Comment) Save the model to a file
saveRDS(ann_model, "ann_model_1.rds")

# Load the model
ann_model <- readRDS("ann_model_1.rds")

ann_prediction <- predict(ann_model, nba_ann_test)

# Display a summary of the ANN model's predictions
summary(ann_prediction)

# Convert the predicted probabilities from the ANN model into binary outcomes: 1 if probability > 0.35, otherwise 0
binary_ann <- ifelse(ann_prediction > .35, 1, 0)

# Generate a confusion matrix to evaluate the performance of the binary predictions against the actual test labels
confusionMatrix(as.factor(binary_ann), as.factor(nba_test_labels), positive = "1")

```

# KNN Model 
```{r}
set.seed(12345)
knnpred <- knn(nba_train, nba_test, nba_train_labels, k = 5, prob=FALSE)

# (Comment) Save the model to a file
saveRDS(knnpred, "knn_model_5.rds")
# Load the model
knn_model <- readRDS("knn_model_5.rds")

# Generate a confusion matrix using the 'caret' library to evaluate the performance of the KNN predictions ('knnpred') against the actual test labels ('tele_test_labels'). The 'positive' argument specifies that the positive class label is "1".
confusionMatrix(as.factor(knn_model), as.factor(nba_test_labels), positive="1")
```



# Decision Tree
```{r}
# No optimization for Decision Tree since we have no learned that yet
install.packages("C50", dependencies = TRUE)

nba_model <- C5.0(SHOT_MADE_FLAG ~ ., data = nba_log_train)
plot(nba_model)

# (Comment) Save the model to a file
saveRDS(nba_model, "tree_model.rds")
# Load the model
tree_model <- readRDS("tree_model.rds")

nba_predict <- predict(tree_model, nba_log_test)

confusionMatrix(as.factor(nba_predict), as.factor(nba_log_test$SHOT_MADE_FLAG), positive = "1")
# plot(hotel_model)

```


# SVM Model
```{r}
m1 <- ksvm(shot_made_flag1 ~ ., data = nba_svm_train, kernel = "vanilladot")
m2 <- ksvm(shot_made_flag1 ~ ., data = nba_svm_train, kernel = "rbfdot")
m3 <- ksvm(shot_made_flag1 ~ ., data = nba_svm_train, kernel = "polydot")
m4 <- ksvm(shot_made_flag1 ~ ., data = nba_svm_train, kernel = "tanhdot")
m5 <- ksvm(shot_made_flag1 ~ ., data = nba_svm_train, kernel = "laplacedot")
m6 <- ksvm(shot_made_flag1 ~ ., data = nba_svm_train, kernel = "besseldot")
m7 <- ksvm(shot_made_flag1 ~ ., data = nba_svm_train, kernel = "anovadot")
m8 <- ksvm(shot_made_flag1 ~ ., data = nba_svm_train, kernel = "splinedot")

p1 <- predict(m1, nba_svm_test)
summary(p1)
p2 <- predict(m2, nba_svm_test)
summary(p2)
p3 <- predict(m3, nba_svm_test)
summary(p3)
p4 <- predict(m4, nba_svm_test)
summary(p4)
p5 <- predict(m5, nba_svm_test)
summary(p5)
p6 <- predict(m6, nba_svm_test)
summary(p6)
p7 <- predict(m7, nba_svm_test)
summary(p7)
p8 <- predict(m8, nba_svm_test)
summary(p8)

confusionMatrix(as.factor(p1),as.factor(nba_svm_test$FGM))
confusionMatrix(as.factor(p2),as.factor(nba_svm_test$FGM))
confusionMatrix(as.factor(p3),as.factor(nba_svm_test$FGM))
confusionMatrix(as.factor(p4),as.factor(nba_svm_test$FGM))
confusionMatrix(as.factor(p5),as.factor(nba_svm_test$FGM))
confusionMatrix(as.factor(p6),as.factor(nba_svm_test$FGM))
confusionMatrix(as.factor(p7),as.factor(nba_svm_test$FGM))
confusionMatrix(as.factor(p8),as.factor(nba_svm_test$FGM))

```


